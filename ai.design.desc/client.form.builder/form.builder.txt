<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ERP Record - Dynamic Form Builder</title>
  <style>
    /* Global Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: #ecf0f1;
      color: #333;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    /* Draggable, Resizable Window Container */
    .window {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 700px;
      min-width: 300px;
      min-height: 400px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }
    .window.hidden {
      display: none;
    }
    .window-header {
      background: #2c3e50;
      color: #fff;
      padding: 8px 12px;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }
    .window-header h2 {
      font-size: 16px;
      margin: 0;
    }
    .window-controls button {
      background: transparent;
      border: none;
      color: #ecf0f1;
      font-size: 16px;
      margin-left: 5px;
      cursor: pointer;
    }
    /* In-window Menu Bar with Submenus */
    .menu-bar {
      background: #34495e;
      padding: 6px 12px;
      position: relative;
    }
    .menu-bar ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }
    .menu-bar li {
      font-size: 14px;
      position: relative;
    }
    .menu-bar a {
      color: #ecf0f1;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.3s;
    }
    .menu-bar a:hover {
      color: #bdc3c7;
    }
    .menu-bar li ul {
      position: absolute;
      top: 100%;
      left: 0;
      background: #34495e;
      padding: 5px 0;
      border-radius: 4px;
      display: none;
      min-width: 120px;
      z-index: 10;
    }
    .menu-bar li:hover > ul {
      display: block;
    }
    .menu-bar li ul li {
      padding: 4px 15px;
    }
    .menu-bar li ul li a {
      font-size: 13px;
      display: block;
    }
    .menu-bar li ul li ul {
      top: 0;
      left: 100%;
      margin-left: 1px;
      display: none;
    }
    .menu-bar li ul li:hover > ul {
      display: block;
    }
    /* Window Body */
    .window-body {
      flex: 1;
      padding: 10px 20px;
      overflow-y: auto;
    }
    /* Window Footer */
    .window-footer {
      background: #f9f9f9;
      border-top: 1px solid #ddd;
      padding: 5px 10px;
      font-size: 13px;
      color: #555;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    /* Dynamic Form Styles */
    form {
      font-size: 13px;
    }
    .form-section {
      margin-bottom: 15px;
    }
    .section-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 3px;
      color: #2c3e50;
    }
    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 15px;
    }
    .form-group {
      display: flex;
      align-items: center;
    }
    .form-group.full-width {
      grid-column: span 2;
    }
    .form-group label {
      width: 100px;
      margin-right: 5px;
      font-size: 13px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      flex: 1;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 50px;
    }
    button.submit-btn {
      padding: 8px 14px;
      font-size: 14px;
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
      display: block;
      margin: 10px auto 0;
    }
    button.submit-btn:hover {
      background: #34495e;
    }
    .success {
      color: #27ae60;
      font-size: 14px;
      text-align: center;
      margin-top: 8px;
    }
    /* Resize Handle */
    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      background: transparent;
      z-index: 101;
    }
  </style>
</head>
<body>
  <div class="window" id="recordWindow">
    <div class="window-header" id="windowHeader">
      <h2 id="formTitle">Record: Data Entry</h2>
      <div class="window-controls">
        <button title="Minimize" id="minimizeBtn">―</button>
        <button title="Close" id="closeBtn">✕</button>
      </div>
    </div>
    <nav class="menu-bar">
      <ul>
        <li>
          <a href="#">Actions</a>
          <ul>
            <li><a href="#">Save</a></li>
            <li>
              <a href="#">More</a>
              <ul>
                <li><a href="#">Duplicate</a></li>
                <li><a href="#">Delete</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="#">Reports</a>
          <ul>
            <li><a href="#">Sales Report</a></li>
            <li><a href="#">Inventory Report</a></li>
          </ul>
        </li>
        <li>
          <a href="#">Export/Import</a>
          <ul>
            <li><a href="#">Export Data</a></li>
            <li><a href="#">Import Data</a></li>
          </ul>
        </li>
      </ul>
    </nav>
    <div class="window-body" id="windowBody">
      <form id="recordForm" novalidate></form>
    </div>
    <div class="window-footer">
      <span id="infoText">Info: All changes saved.</span>
      <span style="cursor: se-resize;">↘</span>
    </div>
    <div class="resize-handle" id="resizeHandle"></div>
  </div>

  <script>
    // Embedded JSON Configuration
    const formConfig = {
      "id": "customerForm",
      "caption": { "key": "customerForm.caption", "default": "Customer Details" },
      "type": "form",
      "dataSource": "customers",
      "layout": {
        "groups": [
          {
            "id": "generalInfo",
            "caption": { "key": "group.generalInfo", "default": "General Information" },
            "fields": [
              {
                "name": "customerId",
                "caption": { "key": "field.customerId", "default": "Customer ID" },
                "type": "text",
                "required": true,
                "maxLength": 10,
                "events": { "change": "validateName" }
              },
              {
                "name": "name",
                "caption": { "key": "field.name", "default": "Name" },
                "type": "text",
                "required": true,
                "maxLength": 100
              },
              {
                "name": "email",
                "caption": { "key": "field.email", "default": "Email" },
                "type": "email",
                "required": true,
                "pattern": "[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$",
                "events": { "blur": "validateEmail" }
              },
              {
                "name": "subscriptionType",
                "caption": { "key": "field.subscriptionType", "default": "Subscription Type" },
                "type": "select",
                "required": true,
                "options": [
                  { "value": "free", "label": { "key": "option.free", "default": "Free" } },
                  { "value": "premium", "label": { "key": "option.premium", "default": "Premium" } },
                  { "value": "enterprise", "label": { "key": "option.enterprise", "default": "Enterprise" } }
                ],
                "defaultValue": "free",
                "events": { "change": "handleSubscriptionChange" }
              }
            ]
          },
          {
            "id": "billingInfo",
            "caption": { "key": "group.billingInfo", "default": "Billing Information" },
            "fields": [
              {
                "name": "billingContact",
                "caption": { "key": "field.billingContact", "default": "Billing Contact" },
                "type": "text",
                "required": true,
                "conditional": {
                  "showWhen": { "field": "subscriptionType", "operator": "notEquals", "value": "free" }
                }
              },
              {
                "name": "paymentTerms",
                "caption": { "key": "field.paymentTerms", "default": "Payment Terms" },
                "type": "select",
                "options": [
                  { "value": "net30", "label": { "key": "option.net30", "default": "Net 30" } },
                  { "value": "net60", "label": { "key": "option.net60", "default": "Net 60" } }
                ],
                "defaultValue": "net30",
                "conditional": {
                  "showWhen": { "field": "subscriptionType", "operator": "notEquals", "value": "free" }
                }
              }
            ]
          },
          {
            "id": "businessInfo",
            "caption": { "key": "group.businessInfo", "default": "Business Information" },
            "conditional": {
              "showWhen": { "field": "isBusiness", "operator": "equals", "value": true }
            },
            "fields": [
              {
                "name": "companyName",
                "caption": { "key": "field.companyName", "default": "Company Name" },
                "type": "text",
                "required": false
              },
              {
                "name": "taxId",
                "caption": { "key": "field.taxId", "default": "Tax ID" },
                "type": "text",
                "required": false
              }
            ]
          },
          {
            "id": "additionalInfo",
            "caption": { "key": "group.additionalInfo", "default": "Additional Information" },
            "fields": [
              {
                "name": "isBusiness",
                "caption": { "key": "field.isBusiness", "default": "Business Customer" },
                "type": "checkbox",
                "defaultValue": false
              },
              {
                "name": "startDate",
                "caption": { "key": "field.startDate", "default": "Start Date" },
                "type": "date",
                "required": false,
                "localeFormat": "YYYY-MM-DD"
              },
              {
                "name": "comments",
                "caption": { "key": "field.comments", "default": "Comments" },
                "type": "textarea",
                "required": false,
                "maxLength": 500
              },
              {
                "name": "salesRep",
                "caption": { "key": "field.salesRep", "default": "Sales Representative" },
                "type": "lookup",
                "required": false,
                "dataSource": "employees",
                "displayField": "name",
                "valueField": "id",
                "defaultValue": null
              }
            ]
          }
        ]
      },
      "permissions": {
        "fields": {
          "customerId": { "editable": false },
          "email": { "editable": true },
          "billingContact": { "editable": true }
        }
      }
    };

    // Placeholder Event Handlers
    function validateName() {
      console.log('Validating customer ID');
    }
    function validateEmail() {
      console.log('Validating email');
    }
    function handleSubscriptionChange() {
      console.log('Subscription type changed');
    }

    // Generate Dynamic Form
    function generateForm(config) {
      const form = document.getElementById('recordForm');
      const fieldMap = {};
      const groupMap = {};

      // Set form title
      document.getElementById('formTitle').textContent = `Record: ${config.caption.default}`;

      // Generate form sections based on groups
      config.layout.groups.forEach(group => {
        const section = document.createElement('div');
        section.className = 'form-section';
        section.id = group.id;
        groupMap[group.id] = section;

        const title = document.createElement('div');
        title.className = 'section-title';
        title.textContent = group.caption.default;
        section.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'field-grid';
        section.appendChild(grid);

        group.fields.forEach(field => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'form-group';
          if (field.fullWidth) {
            groupDiv.classList.add('full-width');
          }

          const label = document.createElement('label');
          label.htmlFor = field.name;
          label.textContent = field.caption.default;
          groupDiv.appendChild(label);

          let input;
          switch (field.type) {
            case 'text':
              input = document.createElement('input');
              input.type = 'text';
              break;
            case 'email':
              input = document.createElement('input');
              input.type = 'email';
              break;
            case 'date':
              input = document.createElement('input');
              input.type = 'date';
              break;
            case 'checkbox':
              input = document.createElement('input');
              input.type = 'checkbox';
              break;
            case 'textarea':
              input = document.createElement('textarea');
              break;
            case 'select':
              input = document.createElement('select');
              field.options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label.default;
                input.appendChild(opt);
              });
              break;
            case 'lookup':
              input = document.createElement('select');
              // Mock options for lookup (replace with actual data fetch in production)
              const mockOptions = [
                { id: '1', name: 'John Doe' },
                { id: '2', name: 'Jane Smith' }
              ];
              mockOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt[field.valueField];
                option.textContent = opt[field.displayField];
                input.appendChild(option);
              });
              break;
            default:
              input = document.createElement('input');
              input.type = 'text';
          }

          input.id = field.name;
          input.name = field.name;

          // Apply field properties
          if (field.required) input.required = true;
          if (field.maxLength) input.maxLength = field.maxLength;
          if (field.pattern) input.pattern = field.pattern;
          if (field.defaultValue !== undefined && field.defaultValue !== null) {
            if (field.type === 'checkbox') {
              input.checked = field.defaultValue;
            } else {
              input.value = field.defaultValue;
            }
          }
          if (config.permissions.fields && config.permissions.fields[field.name] && config.permissions.fields[field.name].editable === false) {
            input.readOnly = true;
          }

          groupDiv.appendChild(input);
          grid.appendChild(groupDiv);
          fieldMap[field.name] = input;
        });

        form.appendChild(section);
      });

      // Add Submit Button
      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.className = 'submit-btn';
      submitBtn.textContent = 'Submit';
      form.appendChild(submitBtn);

      const successDiv = document.createElement('div');
      successDiv.id = 'successMessage';
      successDiv.className = 'success';
      form.appendChild(successDiv);

      // Setup Conditional Logic
      config.layout.groups.forEach(group => {
        // Group-level conditions
        if (group.conditional) {
          const condition = group.conditional.showWhen;
          const triggerField = fieldMap[condition.field];
          if (triggerField) {
            triggerField.addEventListener('change', () => {
              const triggerValue = triggerField.type === 'checkbox' ? triggerField.checked : triggerField.value;
              const conditionValue = condition.value;
              let shouldShow = triggerValue == conditionValue;
              if (condition.operator === 'notEquals') {
                shouldShow = !shouldShow;
              }
              groupMap[group.id].style.display = shouldShow ? 'block' : 'none';
            });
            triggerField.dispatchEvent(new Event('change'));
          }
        }

        // Field-level conditions
        group.fields.forEach(field => {
          if (field.conditional) {
            const condition = field.conditional.showWhen;
            const triggerField = fieldMap[condition.field];
            if (triggerField) {
              const dependentFieldDiv = fieldMap[field.name].parentElement;
              triggerField.addEventListener('change', () => {
                const triggerValue = triggerField.type === 'checkbox' ? triggerField.checked : triggerField.value;
                const conditionValue = condition.value;
                let shouldShow = triggerValue == conditionValue;
                if (condition.operator === 'notEquals') {
                  shouldShow = !shouldShow;
                }
                dependentFieldDiv.style.display = shouldShow ? 'flex' : 'none';
              });
              triggerField.dispatchEvent(new Event('change'));
            }
          }
        });
      });

      // Attach Event Listeners
      config.layout.groups.forEach(group => {
        group.fields.forEach(field => {
          if (field.events) {
            for (const [event, funcName] of Object.entries(field.events)) {
              const input = fieldMap[field.name];
              if (input && window[funcName]) {
                input.addEventListener(event, window[funcName]);
              }
            }
          }
        });
      });
    }

    // Initialize Form
    generateForm(formConfig);

    // Window Drag Functionality
    (function() {
      const windowEl = document.getElementById('recordWindow');
      const header = document.getElementById('windowHeader');
      let offsetX, offsetY, isDragging = false;

      header.addEventListener('mousedown', function(e) {
        isDragging = true;
        offsetX = e.clientX - windowEl.offsetLeft;
        offsetY = e.clientY - windowEl.offsetTop;
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', function(e) {
        if (isDragging) {
          windowEl.style.left = (e.clientX - offsetX) + 'px';
          windowEl.style.top = (e.clientY - offsetY) + 'px';
        }
      });

      document.addEventListener('mouseup', function() {
        isDragging = false;
        document.body.style.userSelect = 'auto';
      });
    })();

    // Window Resizing Functionality
    (function() {
      const windowEl = document.getElementById('recordWindow');
      const handle = document.getElementById('resizeHandle');
      let isResizing = false, startX, startY, startWidth, startHeight;

      handle.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = parseInt(document.defaultView.getComputedStyle(windowEl).width, 10);
        startHeight = parseInt(document.defaultView.getComputedStyle(windowEl).height, 10);
        e.preventDefault();
        e.stopPropagation();
      });

      document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        let newWidth = startWidth + e.clientX - startX;
        let newHeight = startHeight + e.clientY - startY;
        windowEl.style.width = (newWidth > 300 ? newWidth : 300) + 'px';
        windowEl.style.height = (newHeight > 400 ? newHeight : 400) + 'px';
      });

      document.addEventListener('mouseup', function() {
        isResizing = false;
      });
    })();

    // Minimize & Close Functionality
    (function() {
      const minimizeBtn = document.getElementById('minimizeBtn');
      const closeBtn = document.getElementById('closeBtn');
      const windowBody = document.getElementById('windowBody');
      const menuBar = document.querySelector('.menu-bar');
      const windowFooter = document.querySelector('.window-footer');

      minimizeBtn.addEventListener('click', function() {
        if (windowBody.style.display === 'none') {
          windowBody.style.display = 'block';
          menuBar.style.display = 'block';
          windowFooter.style.display = 'flex';
        } else {
          windowBody.style.display = 'none';
          menuBar.style.display = 'none';
          windowFooter.style.display = 'none';
        }
      });

      closeBtn.addEventListener('click', function() {
        document.getElementById('recordWindow').classList.add('hidden');
      });
    })();

    // Form Submission Handling
    (function() {
      const form = document.getElementById('recordForm');
      const successMessage = document.getElementById('successMessage');

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        successMessage.textContent = '';

        if (form.checkValidity()) {
          const formData = new FormData(form);
          const data = {};
          for (const [key, value] of formData.entries()) {
            data[key] = value;
          }
          console.log('Form Data:', data);
          successMessage.textContent = 'Form submitted successfully!';
          // Optionally reset form: form.reset();
        } else {
          form.reportValidity();
        }
      });
    })();
  </script>
</body>
</html>